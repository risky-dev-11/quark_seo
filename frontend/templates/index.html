{% extends "base.html" %}

{% block content %}

  <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/index.css') }}">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.globe.min.js"></script>
  <script>
   document.addEventListener("DOMContentLoaded", function() {
    VANTA.GLOBE({
     el: "#background-canvas",
     mouseControls: true,
     touchControls: true,
     gyroControls: false,
     minHeight: window.innerHeight,
     minWidth: window.innerWidth,
     scale: 0.60,
     scaleMobile: 1.00,
     size: 0.80,
     color: 0x0d42ff,
     color2: 0xffffff,
     backgroundColor: 0x23153c,
    });

    // Ensure position remains static
    document.getElementById("background-canvas").style.position = "static";
   });

  </script>

  <section>
   <div id="background-canvas"></div>
  </section>

  <section id="content-landing-page">
   <div class="container">
   <div class="row gy-4">
    <div class="col-lg-8 d-flex flex-column justify-content-center">
      <h3>Boost Your Website's Visibility</h3>

      <h2>Search Engine Optimization Made Easy</h2>
     <div>
     <form
      id="url-form"
      class="form-search d-flex align-items-stretch"
     >
      <input
       type="text"
       id="url-input"
       class="form-control"
       placeholder="Enter your website URL"
       required
      />
      <button
       id="submit-button"
       type="submit"
       class="btn btn-primary"
      >
       <span class="button-label">Analyse starten</span>
      </button>
     </form>
     <div id="progress-container">
      <div
        id="progress-bar">
      </div>
      <p id="progress-description">The analysis is in progress. Please wait...</p>
    </div>
    </div>
    <p class="landing-page-p">Instantly analyze your website for SEO issues, get actionable recommendations, and track your progress. ASEOTOOL helps you improve your rankings, drive more traffic, and grow your online presence â€” all in just a few clicks.</p>
    </div>
   </div>
   </div>
  </section>

 <script>
   document
  .getElementById('url-form')
  .addEventListener('submit', async function (event) {
   event.preventDefault();

   const inputUrl = document
    .getElementById('url-input')
    .value.trim();
   if (!inputUrl) return;

   const submitButton = document.getElementById('submit-button');
   const buttonLabel = submitButton.querySelector('.button-label');
   const progressContainer = document.getElementById(
    'progress-container'
   );
   const progressDescription = document.getElementById(
    'progress-description'
   );
   const progressBar = document.getElementById('progress-bar');

   const setButtonState = (isLoading) => {
    buttonLabel.innerHTML = isLoading
     ? '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>'
     : 'Analyse starten';
    submitButton.disabled = isLoading;
    progressContainer.style.opacity = isLoading ? '1' : '0';
    if (!isLoading) {
     // reset bar when hiding
     progressBar.style.width = '0%';
    }
   };

   const resetProgress = () => {
    progressBar.style.width = '0%';
    progressDescription.textContent =
     'The analysis is in progress. Please wait...';
   };

   setButtonState(true);

   const encodedUrl = encodeURIComponent(inputUrl);
   const evtSource = new EventSource(
    `/api/analyze/stream/${encodedUrl}`
   );

   let progressInterval = null;

   evtSource.onmessage = function (event) {
    const [progress, message] = event.data.split('|');

    if (progress === 'DONE' || progress === 'ERROR') {
     evtSource.close();
     setButtonState(false);
     if (progressInterval) {
      clearInterval(progressInterval);
      progressInterval = null;
     }
     resetProgress();
     const resultPath = progress === 'DONE' ? message : 'error';
     window.location.href = `/results/${encodedUrl}/${resultPath}`;
    } else {
     // update description text
     progressDescription.textContent = message;

     const targetWidth = parseFloat(progress);
     let currentWidth =
      parseFloat(progressBar.style.width) || 0;

     if (progressInterval) {
      clearInterval(progressInterval);
     }
     progressInterval = setInterval(() => {
      currentWidth = Math.min(
       currentWidth + 1,
       targetWidth
      );
      progressBar.style.width = `${currentWidth}%`;
      if (currentWidth >= targetWidth) {
       clearInterval(progressInterval);
       progressInterval = null;
      }
     }, 25);
    }
   };
  });
 </script>

{% endblock %}

{% block footer %}
{# empty block to suppress footer #}
{% endblock %}